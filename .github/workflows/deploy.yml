name: Deploy to Hostinger

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      release_version:
        description: 'Release version to deploy (e.g., 3.1.0)'
        required: false
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Find Latest Release Instructions
        id: release
        run: |
          # Find latest release file or use specified version
          if [ -n "${{ github.event.inputs.release_version }}" ]; then
            RELEASE_FILE=".github/releases/v${{ github.event.inputs.release_version }}.json"
          else
            # Find latest release excluding archive folder
            RELEASE_FILE=$(find .github/releases -maxdepth 1 -name "*.json" -type f | sort -V | tail -n1)
          fi
          
          if [ ! -f "$RELEASE_FILE" ]; then
            echo "ERROR: No release instructions found"
            exit 1
          fi
          
          echo "release_file=$RELEASE_FILE" >> $GITHUB_OUTPUT
          
          # Extract version and description
          VERSION=$(jq -r '.version' "$RELEASE_FILE")
          DESCRIPTION=$(jq -r '.description' "$RELEASE_FILE")
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "description=$DESCRIPTION" >> $GITHUB_OUTPUT
          
          echo "=========================================="
          echo "Release: v$VERSION"
          echo "Description: $DESCRIPTION"
          echo "Instructions: $RELEASE_FILE"
          echo "=========================================="
          
      - name: Validate Release Instructions
        run: |
          RELEASE_FILE="${{ steps.release.outputs.release_file }}"
          
          # Validate JSON format
          if ! jq empty "$RELEASE_FILE" 2>/dev/null; then
            echo "ERROR: Invalid JSON in $RELEASE_FILE"
            exit 1
          fi
          
          # Check required fields
          if ! jq -e '.version' "$RELEASE_FILE" > /dev/null; then
            echo "ERROR: Missing 'version' field"
            exit 1
          fi
          
          if ! jq -e '.steps' "$RELEASE_FILE" > /dev/null; then
            echo "ERROR: Missing 'steps' field"
            exit 1
          fi
          
          echo "✓ Release instructions are valid"

      - name: Check for Elementor Deployment
        id: check_elementor
        run: |
          RELEASE_FILE="${{ steps.release.outputs.release_file }}"
          HAS_ELEMENTOR=$(jq '[.steps[] | select(.type == "deploy_elementor")] | length > 0' "$RELEASE_FILE")
          echo "has_elementor=$HAS_ELEMENTOR" >> $GITHUB_OUTPUT
          
          if [ "$HAS_ELEMENTOR" = "true" ]; then
            echo "⚠️  This release includes Elementor page deployment"
            echo "⚠️  Ensure Elementor exports are committed to repository"
          fi

          if [ "$HAS_ELEMENTOR" = "true" ]; then
            echo "⚠️  This release includes Elementor page deployment"
            echo "⚠️  Ensure Elementor exports are committed to repository"
          fi

      - name: Deploy Code (wp-content)
        id: deploy_code
        run: |
          RELEASE_FILE="${{ steps.release.outputs.release_file }}"
          
          # Check if release has deploy_code step
          HAS_CODE=$(jq '[.steps[] | select(.type == "deploy_code")] | length > 0' "$RELEASE_FILE")
          
          if [ "$HAS_CODE" = "false" ]; then
            echo "No code deployment in this release"
            exit 0
          fi
          
          echo "Preparing code deployment..."
          
          # Create clean deployment directory
          mkdir -p deploy
          
          # Copy wp-content to deployment staging
          cp -r wp-content deploy/
          
          # Apply .hostingerignore exclusions
          if [ -f .hostingerignore ]; then
            echo "Applying .hostingerignore exclusions..."
            
            while IFS= read -r pattern || [ -n "$pattern" ]; do
              [[ -z "$pattern" || "$pattern" =~ ^#.*$ ]] && continue
              pattern=$(echo "$pattern" | xargs)
              [[ -z "$pattern" ]] && continue
              
              if [[ "$pattern" == wp-content/* ]]; then
                clean_pattern="${pattern#wp-content/}"
                if [[ "$clean_pattern" == *"*"* ]]; then
                  if [[ "$clean_pattern" == *"/"* ]]; then
                    find deploy/wp-content -path "deploy/wp-content/$clean_pattern" -exec rm -rf {} + 2>/dev/null || true
                  else
                    find deploy/wp-content -name "$clean_pattern" -exec rm -rf {} + 2>/dev/null || true
                  fi
                else
                  if [ -e "deploy/wp-content/$clean_pattern" ]; then
                    rm -rf "deploy/wp-content/$clean_pattern"
                  fi
                fi
              elif [[ "$pattern" == *"*"* ]]; then
                find deploy -name "$pattern" -exec rm -rf {} + 2>/dev/null || true
              fi
            done < .hostingerignore
          fi
          
          # Show deployment summary
          echo "Deployment Summary:"
          echo "----------------------------------------"
          total_files=$(find deploy -type f | wc -l)
          total_size=$(du -sh deploy | cut -f1)
          echo "Total files: $total_files"
          echo "Total size: $total_size"
          echo "code_deployed=true" >> $GITHUB_OUTPUT

      - name: Upload Code to Hostinger
        if: steps.deploy_code.outputs.code_deployed == 'true'
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HOSTINGER_HOST }}
          username: ${{ secrets.HOSTINGER_USER }}
          key: ${{ secrets.HOSTINGER_SSH_KEY }}
          port: ${{ secrets.HOSTINGER_PORT }}
          source: "deploy/wp-content/*"
          target: "${{ secrets.HOSTINGER_PATH }}/"
          strip_components: 1
          overwrite: true

      - name: Deploy Database Changes
        id: deploy_database
        run: |
          RELEASE_FILE="${{ steps.release.outputs.release_file }}"
          
          # Check if release has database deployment
          HAS_DATABASE=$(jq '[.steps[] | select(.type == "deploy_database")] | length > 0' "$RELEASE_FILE")
          
          if [ "$HAS_DATABASE" = "false" ]; then
            echo "No database deployment in this release"
            exit 0
          fi
          
          echo "Preparing database deployment..."
          echo "database_deployed=true" >> $GITHUB_OUTPUT
          
          # Extract SQL files from release config
          jq -r '.steps[] | select(.type == "deploy_database") | .config.sql_files[]' "$RELEASE_FILE" > db_files.txt
          
          echo "SQL files to deploy:"
          cat db_files.txt

      - name: Upload and Execute Database Changes
        if: steps.deploy_database.outputs.database_deployed == 'true'
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HOSTINGER_HOST }}
          username: ${{ secrets.HOSTINGER_USER }}
          key: ${{ secrets.HOSTINGER_SSH_KEY }}
          port: ${{ secrets.HOSTINGER_PORT }}
          source: "infra/shared/db/*.sql"
          target: "~/db-deploy/"
          strip_components: 3

      - name: Execute Database SQL Files
        if: steps.deploy_database.outputs.database_deployed == 'true'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOSTINGER_HOST }}
          username: ${{ secrets.HOSTINGER_USER }}
          key: ${{ secrets.HOSTINGER_SSH_KEY }}
          port: ${{ secrets.HOSTINGER_PORT }}
          script: |
            cd ${{ secrets.HOSTINGER_WP_ROOT }}
            
            echo "Executing database migrations..."
            
            for sql_file in ~/db-deploy/*.sql; do
              if [ -f "$sql_file" ]; then
                echo "Executing: $(basename $sql_file)"
                wp db query < "$sql_file" && echo "✓ Success" || echo "✗ Failed: $sql_file"
              fi
            done
            
            # Cleanup
            rm -rf ~/db-deploy
            
            echo "Database deployment complete"

      - name: Activate Theme
        id: activate_theme
        run: |
          RELEASE_FILE="${{ steps.release.outputs.release_file }}"
          
          # Check if release has theme activation
          HAS_THEME=$(jq '[.steps[] | select(.type == "activate_theme")] | length > 0' "$RELEASE_FILE")
          
          if [ "$HAS_THEME" = "false" ]; then
            echo "No theme activation in this release"
            exit 0
          fi
          
          THEME=$(jq -r '.steps[] | select(.type == "activate_theme") | .config.theme' "$RELEASE_FILE")
          echo "theme_name=$THEME" >> $GITHUB_OUTPUT
          echo "theme_activated=true" >> $GITHUB_OUTPUT

      - name: Execute Theme Activation
        if: steps.activate_theme.outputs.theme_activated == 'true'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOSTINGER_HOST }}
          username: ${{ secrets.HOSTINGER_USER }}
          key: ${{ secrets.HOSTINGER_SSH_KEY }}
          port: ${{ secrets.HOSTINGER_PORT }}
          script: |
            cd ${{ secrets.HOSTINGER_WP_ROOT }}
            
            THEME="${{ steps.activate_theme.outputs.theme_name }}"
            echo "Activating theme: $THEME"
            
            if wp theme activate "$THEME"; then
              echo "✓ Theme activated: $THEME"
            else
              echo "✗ Theme activation failed: $THEME"
              exit 1
            fi

      - name: Deploy Elementor Pages
        if: steps.check_elementor.outputs.has_elementor == 'true'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOSTINGER_HOST }}
          username: ${{ secrets.HOSTINGER_USER }}
          key: ${{ secrets.HOSTINGER_SSH_KEY }}
          port: ${{ secrets.HOSTINGER_PORT }}
          script: |
            cd ${{ secrets.HOSTINGER_WP_ROOT }}
            
            # Create elementor-exports directory if not exists
            mkdir -p ~/elementor-exports
            
            echo "⚠️  ELEMENTOR DEPLOYMENT REQUIRES MANUAL STEPS"
            echo "================================================"
            echo ""
            echo "Elementor pages cannot be fully automated in CI/CD because:"
            echo "  - Exports require running local WordPress container"
            echo "  - Binary-safe file handling needed to avoid encoding corruption"
            echo ""
            echo "Follow these steps to complete Elementor deployment:"
            echo ""
            echo "1. Export pages locally:"
            echo "   pwsh infra/shared/scripts/export-elementor-pages.ps1"
            echo ""
            echo "2. Upload exports to production:"
            echo "   scp -r tmp/elementor-exports/ ${{ secrets.HOSTINGER_USER }}@${{ secrets.HOSTINGER_HOST }}:~/"
            echo ""
            echo "3. Upload import script:"
            echo "   scp infra/shared/scripts/import-elementor-pages.php ${{ secrets.HOSTINGER_USER }}@${{ secrets.HOSTINGER_HOST }}:~/elementor-exports/"
            echo ""
            echo "4. Execute import on production:"
            echo "   ssh ${{ secrets.HOSTINGER_USER }}@${{ secrets.HOSTINGER_HOST }} 'cd ${{ secrets.HOSTINGER_WP_ROOT }} && wp eval-file ~/elementor-exports/import-elementor-pages.php'"
            echo ""
            echo "5. Clear caches:"
            echo "   ssh ${{ secrets.HOSTINGER_USER }}@${{ secrets.HOSTINGER_HOST }} 'cd ${{ secrets.HOSTINGER_WP_ROOT }} && wp elementor flush_css && wp litespeed-purge all'"
            echo ""
            echo "================================================"

      - name: Clear Caches
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOSTINGER_HOST }}
          username: ${{ secrets.HOSTINGER_USER }}
          key: ${{ secrets.HOSTINGER_SSH_KEY }}
          port: ${{ secrets.HOSTINGER_PORT }}
          script: |
            cd ${{ secrets.HOSTINGER_WP_ROOT }}
            
            echo "Clearing caches..."
            
            # Clear Elementor cache
            if wp elementor flush_css 2>/dev/null; then
              echo "✓ Elementor cache cleared"
            else
              echo "⚠ Elementor cache clear failed or plugin not active"
            fi
            
            # Clear LiteSpeed cache (if available)
            if command -v litespeed 2>/dev/null; then
              wp litespeed-purge all 2>/dev/null && echo "✓ LiteSpeed cache cleared" || echo "⚠ LiteSpeed cache clear failed"
            fi
            
            # Clear WordPress transients
            wp transient delete --all 2>/dev/null && echo "✓ WordPress transients cleared" || true
            
            echo "Cache clearing complete"

      - name: Deployment Summary
        if: always()
        run: |
          RELEASE_FILE="${{ steps.release.outputs.release_file }}"
          VERSION="${{ steps.release.outputs.version }}"
          
          echo ""
          echo "=========================================="
          echo "Deployment Summary"
          echo "=========================================="
          echo "Release: v$VERSION"
          echo "Description: ${{ steps.release.outputs.description }}"
          echo "Code deployed: ${{ steps.deploy_code.outputs.code_deployed || 'false' }}"
          echo "Database deployed: ${{ steps.deploy_database.outputs.database_deployed || 'false' }}"
          echo "Theme activated: ${{ steps.activate_theme.outputs.theme_activated || 'false' }}"
          echo "Elementor pages: ${{ steps.check_elementor.outputs.has_elementor }}"
          echo "=========================================="
          echo ""
          if [ "${{ steps.check_elementor.outputs.has_elementor }}" = "true" ]; then
            echo "⚠️  MANUAL ELEMENTOR DEPLOYMENT REQUIRED - See above for instructions"
            echo ""
          fi
          echo "Manual Verification Steps:"
          jq -r '.steps[] | select(.type == "manual") | .config.instructions[]' "$RELEASE_FILE" 2>/dev/null || echo "  None specified"
          echo ""
          echo "Deployment complete!"
