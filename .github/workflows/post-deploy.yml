name: Post-Deployment Cleanup

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to archive (e.g., 3.3.0)'
        required: true
        type: string
      confirmed:
        description: 'Confirm production review complete (yes/no)'
        required: true
        type: choice
        options:
          - 'no'
          - 'yes'

jobs:
  archive-release:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirmed == 'yes'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Validate Release File
        id: validate
        run: |
          VERSION="${{ github.event.inputs.version }}"
          RELEASE_FILE=".github/releases/v${VERSION}.json"
          
          if [ ! -f "$RELEASE_FILE" ]; then
            echo "ERROR: Release file not found: $RELEASE_FILE"
            exit 1
          fi
          
          echo "release_file=$RELEASE_FILE" >> $GITHUB_OUTPUT
          echo "Found release file: $RELEASE_FILE"

      - name: Configure Git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: Switch to Develop Branch
        run: |
          git checkout develop
          git pull origin develop

      - name: Archive Release File
        run: |
          VERSION="${{ github.event.inputs.version }}"
          RELEASE_FILE=".github/releases/v${VERSION}.json"
          ARCHIVE_DIR=".github/releases/archive"
          
          echo "Archiving release v${VERSION}..."
          
          # Ensure archive directory exists
          mkdir -p "$ARCHIVE_DIR"
          
          # Move release file to archive
          git mv "$RELEASE_FILE" "$ARCHIVE_DIR/v${VERSION}.json"
          
          echo "âœ“ Moved $RELEASE_FILE to archive"

      - name: Prepare Next Release Version
        run: |
          VERSION="${{ github.event.inputs.version }}"
          
          # Parse version numbers
          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f2)
          PATCH=$(echo $VERSION | cut -d. -f3)
          
          # Increment minor version for next release
          NEXT_MINOR=$((MINOR + 1))
          NEXT_VERSION="${MAJOR}.${NEXT_MINOR}.0"
          
          echo "Current version: ${VERSION}"
          echo "Next version: ${NEXT_VERSION}"
          echo "next_version=${NEXT_VERSION}" >> $GITHUB_ENV

      - name: Create Next Release Template
        run: |
          NEXT_VERSION="${{ env.next_version }}"
          NEXT_FILE=".github/releases/v${NEXT_VERSION}.json"
          
          cat > "$NEXT_FILE" << 'EOF'
{
  "version": "'"${NEXT_VERSION}"'",
  "release_date": "TBD",
  "description": "Next release - description TBD",
  "requires_db_backup": false,
  "requires_manual_verification": true,
  "changelog": [
    "Add changelog items here"
  ],
  "steps": [
    {
      "type": "deploy_code",
      "description": "Deploy wp-content (plugins, themes) to production",
      "config": {
        "source": "wp-content/",
        "destination": "/domains/talendelight.com/public_html/wp-content/",
        "exclude": ["uploads/", "upgrade/", "upgrade-temp-backup/", "*.log"],
        "rsync_flags": "-avz --delete --exclude-from=.hostingerignore",
        "critical_files": []
      }
    },
    {
      "type": "clear_cache",
      "description": "Clear LiteSpeed and Elementor caches",
      "config": {
        "cache_types": ["litespeed", "elementor"]
      }
    },
    {
      "type": "manual",
      "description": "Verify deployment",
      "config": {
        "instructions": [
          "1. Verify deployed features on production site",
          "2. Test all functionality",
          "3. Check error logs",
          "4. Monitor for issues"
        ],
        "approve_before_continue": false
      }
    }
  ]
}
EOF
          
          git add "$NEXT_FILE"
          echo "âœ“ Created next release template: $NEXT_FILE"

      - name: Update RELEASE-NOTES-NEXT.md
        run: |
          PREV_VERSION="${{ github.event.inputs.version }}"
          NEXT_VERSION="${{ env.next_version }}"
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
          
          # Archive current release notes with timestamp
          ARCHIVE_NOTES=".github/releases/archive/RELEASE-NOTES-${TIMESTAMP//:/-}.md"
          
          if [ -f "docs/RELEASE-NOTES-NEXT.md" ]; then
            # Add header with version info
            {
              echo "# Release Notes - v${PREV_VERSION}"
              echo ""
              echo "**Deployed:** ${TIMESTAMP}"
              echo "**Archived:** ${TIMESTAMP}"
              echo ""
              echo "---"
              echo ""
              cat docs/RELEASE-NOTES-NEXT.md
            } > "$ARCHIVE_NOTES"
            
            git add "$ARCHIVE_NOTES"
            echo "âœ“ Archived release notes to: $ARCHIVE_NOTES"
          fi
          
          # Create fresh RELEASE-NOTES-NEXT.md for next version
          cat > docs/RELEASE-NOTES-NEXT.md << 'EOF'
# Release Notes & Deployment Instructions

**Status:** ðŸ”„ Planning

This document tracks all manual deployment steps required for the **next production release**.

**Purpose:** Ensure consistent, error-free deployments by documenting every manual step needed after Git push to main branch.

**ðŸ“‹ See Process:** [RELEASE-NOTES-PROCESS.md](RELEASE-NOTES-PROCESS.md) for workflow documentation

---

## Release Information

**Target Deployment Date:** TBD  
**Release Version:** '"${NEXT_VERSION}"'  
**Branch:** develop â†’ main  
**Status:** ðŸ”„ Planning

### Overview

**v'"${PREV_VERSION}"' Deployment Complete:** âœ… '"${TIMESTAMP}"'
- See [VERSION-HISTORY.md](VERSION-HISTORY.md) for complete v'"${PREV_VERSION}"' details
- Release archived in .github/releases/archive/

**Next Release (v'"${NEXT_VERSION}"') - Planning:**
- [ ] Define features and changes
- [ ] Update changelog in .github/releases/v'"${NEXT_VERSION}"'.json
- [ ] Document deployment steps
- [ ] Test locally before deployment

---

## Deployment Steps

_To be defined..._

---

## Manual Verification Checklist

- [ ] All pages loading correctly
- [ ] No console errors
- [ ] Functionality works as expected
- [ ] Mobile responsive
- [ ] Performance acceptable

---

## Rollback Plan

If issues occur:
1. Revert to previous Git commit
2. Restore database backup (if database changes were made)
3. Clear all caches
4. Verify rollback successful

EOF
          
          git add docs/RELEASE-NOTES-NEXT.md
          echo "âœ“ Reset RELEASE-NOTES-NEXT.md for v${NEXT_VERSION}"

      - name: Update VERSION-HISTORY.md
        run: |
          VERSION="${{ github.event.inputs.version }}"
          TIMESTAMP=$(date -u +"%Y-%m-%d")
          
          # Read current version description from release file
          ARCHIVE_FILE=".github/releases/archive/v${VERSION}.json"
          DESCRIPTION=$(jq -r '.description' "$ARCHIVE_FILE")
          
          # Create version entry
          VERSION_ENTRY="### v${VERSION}

**Deployed:** ${TIMESTAMP}  
**Status:** âœ… Production  

**Description:** ${DESCRIPTION}

**See:** .github/releases/archive/v${VERSION}.json for complete deployment details

---
"
          
          # Insert after version section header
          if grep -q "## Version ${VERSION%%.*}.x.x" docs/VERSION-HISTORY.md; then
            # Version section exists, insert after it
            sed -i "/## Version ${VERSION%%.*}.x.x/a\\
\\
$VERSION_ENTRY" docs/VERSION-HISTORY.md
          else
            # Append to file
            echo "$VERSION_ENTRY" >> docs/VERSION-HISTORY.md
          fi
          
          git add docs/VERSION-HISTORY.md
          echo "âœ“ Updated VERSION-HISTORY.md with v${VERSION}"

      - name: Commit Changes
        run: |
          VERSION="${{ github.event.inputs.version }}"
          NEXT_VERSION="${{ env.next_version }}"
          
          git commit -m "Archive v${VERSION}, prepare v${NEXT_VERSION}

- Move .github/releases/v${VERSION}.json to archive/
- Archive release notes with timestamp
- Create .github/releases/v${NEXT_VERSION}.json template
- Reset RELEASE-NOTES-NEXT.md for v${NEXT_VERSION}
- Update VERSION-HISTORY.md with v${VERSION} deployment

Post-deployment cleanup after successful v${VERSION} review."

      - name: Push to Develop
        run: |
          git push origin develop
          echo "âœ“ Changes pushed to develop branch"

      - name: Merge to Main
        run: |
          git checkout main
          git merge develop --no-edit
          git push origin main
          echo "âœ“ Changes merged to main branch"

      - name: Cleanup Summary
        run: |
          VERSION="${{ github.event.inputs.version }}"
          NEXT_VERSION="${{ env.next_version }}"
          
          echo ""
          echo "=========================================="
          echo "Post-Deployment Cleanup Complete"
          echo "=========================================="
          echo "Archived version: v${VERSION}"
          echo "Next version: v${NEXT_VERSION}"
          echo ""
          echo "Changes made:"
          echo "  âœ“ Archived v${VERSION}.json to archive/"
          echo "  âœ“ Archived release notes with timestamp"
          echo "  âœ“ Created v${NEXT_VERSION}.json template"
          echo "  âœ“ Reset RELEASE-NOTES-NEXT.md"
          echo "  âœ“ Updated VERSION-HISTORY.md"
          echo "  âœ“ Pushed to develop and main branches"
          echo ""
          echo "You can now start planning v${NEXT_VERSION}!"
          echo "=========================================="

  rejected:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirmed == 'no'
    steps:
      - name: Rejection Notice
        run: |
          echo ""
          echo "=========================================="
          echo "Post-Deployment Cleanup CANCELLED"
          echo "=========================================="
          echo ""
          echo "Production review not confirmed."
          echo "Please complete production review before archiving the release."
          echo ""
          echo "To run this workflow after review:"
          echo "  gh workflow run post-deploy.yml -f version=${{ github.event.inputs.version }} -f confirmed=yes"
          echo ""
          echo "=========================================="
          exit 1
