# v3.4.0 Release Summary

**Date:** January 21, 2026  
**Status:** ✅ Deployed to Production  

---

## What's New

### 1. Manager Admin Operations Page
- **URL:** `/manager-admin/`
- **Tabbed Interface:** 4 tabs (Submitted, Approved, Rejected, All)
- **Real-time Actions:** Approve (✓), Reject (✗), Undo (↶)
- **Role-based Display:** Shows role badges (Candidate, Employer, Scout, Operator, Manager)
- **Profile Methods:** Supports both LinkedIn + CV display
- **Database Integration:** Live data from `td_user_data_change_requests` table

### 2. Generic Audit Logging System
- **Table:** `td_audit_log`
- **Tracks:** All database changes (insert, update, delete, approve, reject, undo)
- **Records:** User ID, timestamp, IP address, user agent, old/new values
- **Purpose:** Compliance, security, troubleshooting

### 3. Enhanced User Requests Schema
- **New Columns:**
  - `role` - User role (candidate, employer, scout, operator, manager)
  - `has_linkedin` - Boolean flag for LinkedIn profile
  - `has_cv` - Boolean flag for CV upload
- **Supports:** Multiple profile methods per request

---

## Files Changed

### Database Migrations
1. `infra/shared/db/260117-impl-add-td_user_data_change_requests.sql` - Base table
2. `infra/shared/db/260119-1400-add-role-and-audit-log.sql` - Role & audit log

### mu-plugins (Auto-loaded)
1. `wp-content/mu-plugins/user-requests-display.php` - Shortcode and AJAX handlers
2. `wp-content/mu-plugins/audit-logger.php` - Audit logging helper class
3. `wp-content/mu-plugins/forminator-custom-table.php` - ✅ Updated to support form ID 80 (production) and 364 (local)

### Elementor Pages
1. `managers` (ID 469 local, production ID TBD) - ✅ Managers Dashboard (deployed Jan 21)
2. `manager-admin` (ID 386 local, ID 86 production) - ✅ Manager Admin Operations page (deployed Jan 21)

### Documentation
1. `docs/RELEASE-NOTES-NEXT.md` - Human-readable deployment steps
2. `.github/releases/v3.4.0.json` - Machine-readable deployment manifest
3. `docs/MANAGER-ADMIN-TABS-IMPLEMENTATION.md` - Implementation guide
4. `docs/features/WP-01.6-user-request-approvals.md` - Feature specification

---

## Technical Implementation

### Shortcode Usage
```php
[user_requests_table status="pending"]
[user_requests_table status="approved" days="90"]
[user_requests_table status="rejected" days="90"]
[user_requests_table status="all" days="90"]
```

### AJAX Actions
```javascript
wp_ajax_td_approve_request   // Approve pending request
wp_ajax_td_reject_request    // Reject pending request
wp_ajax_td_undo_reject       // Undo rejected request
```

### Audit Logging
```php
TD_Audit_Logger::log(
    $table_name,    // 'td_user_data_change_requests'
    $record_id,     // Request ID
    $action,        // 'approve', 'reject', 'undo'
    $old_value,     // Previous status
    $new_value,     // New status
    $column_name,   // 'status'
    $notes          // Optional context
);
```

---

## Testing Checklist

### Local Testing
- [x] Database migrations applied
- [x] Sample data inserted
- [x] Tabs render correctly
- [x] Approve action works
- [x] Reject action works
- [x] Undo action works
- [x] Audit log entries created
- [x] Role badges display
- [x] Profile methods show correctly

### Production Testing (Post-Deployment)
- [x] Pages deployed successfully (Manager Dashboard + Manager Admin)
- [x] Database migrations applied (all 3 migration files)
- [x] mu-plugins loaded and verified
- [x] AJAX endpoints working (approve, reject, undo)
- [x] Access control verified (Manager/Admin only)
- [x] Audit log capturing changes
- [x] Form submissions syncing to requests table
- [ ] No console errors (requires browser testing)
- [ ] Mobile responsive (requires browser testing)

---

## Rollback Plan

If issues occur after deployment:

1. **Revert code:**
   ```bash
   git revert <commit-hash>
   git push origin main
   ```

2. **Rollback database (if needed):**
   ```bash
   wp db query "DROP TABLE IF EXISTS td_audit_log;"
   wp db query "ALTER TABLE td_user_data_change_requests DROP COLUMN role, DROP COLUMN has_linkedin, DROP COLUMN has_cv;"
   ```

3. **Disable mu-plugins:**
   ```bash
   mv wp-content/mu-plugins/user-requests-display.php wp-content/mu-plugins/user-requests-display.php.disabled
   mv wp-content/mu-plugins/audit-logger.php wp-content/mu-plugins/audit-logger.php.disabled
   ```

---

## Deployment Lessons Learned (January 21, 2026)

### Issue 1: PowerShell Encoding Corrupted Elementor JSON
**Problem:** Manager Admin page deployed with broken structure - shortcode attributes had unescaped quotes  
**Cause:** PowerShell piping (`>` or `|`) corrupted JSON encoding  
**Solution:** Use `podman cp` for binary-safe file transfer  
**Documentation:** [lessons/elementor-json-corruption-shortcodes.md](lessons/elementor-json-corruption-shortcodes.md)

### Issue 2: WordPress Meta API Modified Data on Save
**Problem:** `update_post_meta()` and even `delete_post_meta()` + `add_post_meta()` modified JSON during save  
**Cause:** WordPress processes meta values through serialization/unserialization  
**Solution:** Direct database update using `$wpdb->update()` on `wp_postmeta` table  
**Result:** Exact byte match (13,821 bytes), valid JSON, all shortcodes properly escaped

### Issue 3: MU-Plugin Hardcoded to Local Form ID
**Problem:** Form submissions not appearing in Manager Admin on production  
**Cause:** `forminator-custom-table.php` only checked for form ID 364 (local), production uses ID 80  
**Solution:** Support both form IDs: `$target_form_ids = [364, 80];`  
**Additional:** Backfilled 4 existing production form submissions with dedicated script

### Key Takeaways
1. **Always use `podman cp`** for Elementor JSON exports (never PowerShell piping)
2. **Direct database updates** are most reliable for large/complex Elementor data
3. **Environment-specific IDs** must be configurable (form IDs, page IDs, etc.)
4. **Verify data immediately** after deployment (don't assume silent failures mean success)

---

## Next Steps (Future Releases)

### v3.5.0 (Planned)
- Full detail view modal for requests
- Bulk approve/reject actions
- Advanced filtering (by role, date range, type)
- Email notifications for status changes
- Export to CSV functionality

### v3.6.0 (Planned)
- User Management section (tile #2)
- System Settings section (tile #3)
- Role Management section (tile #5)

---

## References

- [Feature Spec: WP-01.6](docs/features/WP-01.6-user-request-approvals.md)
- [Implementation Guide](docs/MANAGER-ADMIN-TABS-IMPLEMENTATION.md)
- [Release Process](docs/RELEASE-NOTES-PROCESS.md)
- [Deployment Workflow](docs/DEPLOYMENT-WORKFLOW.md)
